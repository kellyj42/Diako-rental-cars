{% extends "base.html" %}
{% load static %}
{% block title %}My Bookings - Diako Rentals{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-8 md:py-12 px-4">
  <div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8 md:mb-12">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">
            My Bookings
          </h1>
          <p class="text-gray-600">Track and manage all your car rental reservations</p>
        </div>
        
        <!-- Quick Stats -->
        <div class="flex items-center gap-4">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
            <div class="text-2xl font-bold text-blue-600">{{ total_bookings }}</div>
            <div class="text-sm text-gray-500">Total</div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
            <div class="text-2xl font-bold text-green-600">{{ upcoming_bookings }}</div>
            <div class="text-sm text-gray-500">Upcoming</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Actions -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <!-- Filter Tabs -->
        <div class="flex flex-wrap gap-2">
          <button data-filter="all" class="filter-btn active px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 bg-blue-600 text-white">
            All Bookings
          </button>
          <button data-filter="upcoming" class="filter-btn px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 bg-white text-gray-700 border border-gray-300 hover:border-blue-500">
            Upcoming
          </button>
          <button data-filter="completed" class="filter-btn px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 bg-white text-gray-700 border border-gray-300 hover:border-green-500">
            Completed
          </button>
          <button data-filter="cancelled" class="filter-btn px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 bg-white text-gray-700 border border-gray-300 hover:border-red-500">
            Cancelled
          </button>
        </div>

        <!-- Sort Dropdown -->
        <div class="relative">
          <select id="sortSelect" class="appearance-none bg-white border border-gray-300 rounded-xl px-4 py-2.5 pr-10 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
            <option value="newest">Sort by: Newest First</option>
            <option value="oldest">Sort by: Oldest First</option>
            <option value="price_high">Sort by: Price High to Low</option>
            <option value="price_low">Sort by: Price Low to High</option>
          </select>
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
            <i class="fas fa-chevron-down text-gray-400"></i>
          </div>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="mt-6">
        <div class="relative max-w-md">
          <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search by car name, booking ID, or location..." 
            class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
        </div>
      </div>
    </div>

    {% if bookings %}
      <!-- Bookings Grid -->
      <div id="bookingsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% for booking in bookings %}
          <div class="booking-card bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1"
               data-status="{{ booking.status }}"
               data-id="{{ booking.id }}"
               data-date="{{ booking.pick_up_date|date:'Y-m-d' }}"
               data-price="{{ booking.total_price }}">
            <!-- Booking Header -->
            <div class="border-b border-gray-100 px-6 py-4 bg-gradient-to-r from-gray-50 to-white">
              <div class="flex justify-between items-center">
                <div>
                  <span class="text-xs font-semibold text-gray-500 tracking-wider">BOOKING ID</span>
                  <h3 class="text-lg font-bold text-gray-900">#{{ booking.id|stringformat:"06d" }}</h3>
                </div>
                <div class="text-right">
                  <span class="text-xs text-gray-500">Booked on</span>
                  <p class="text-sm font-medium text-gray-900">{{ booking.created_at|date:"M d, Y" }}</p>
                </div>
              </div>
            </div>

            <div class="p-6">
              <div class="flex flex-col md:flex-row gap-6">
                <!-- Car Image & Info -->
                <div class="md:w-2/5">
                  <div class="relative rounded-xl overflow-hidden mb-4">
                    <img
                      src="{{ booking.car.thumbnail.url|default:'/static/images/car-placeholder.jpg' }}"
                      alt="{{ booking.car.name }}"
                      class="w-full h-48 object-cover transition-transform duration-500 hover:scale-105"
                    >
                    <div class="absolute top-3 left-3">
                      <span class="bg-black/70 text-white px-3 py-1 rounded-full text-xs font-semibold">
                        {{ booking.car.category|default:"Premium" }}
                      </span>
                    </div>
                  </div>
                  
                  <h4 class="text-xl font-bold text-gray-900 mb-1">{{ booking.car.name }}</h4>
                  <div class="flex items-center gap-2 text-gray-600 text-sm mb-2">
                    <i class="fas fa-gas-pump"></i>
                    <span>{{ booking.car.fuel_type|default:"Petrol" }}</span>
                    <span class="mx-1">â€¢</span>
                    <i class="fas fa-cogs"></i>
                    <span>{{ booking.car.transmission|default:"Automatic" }}</span>
                  </div>
                </div>

                <!-- Booking Details -->
                <div class="md:w-3/5">
                  <!-- Trip Details -->
                  <div class="mb-6">
                    <h5 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                      <i class="fas fa-route text-blue-500"></i>
                      Trip Details
                    </h5>
                    <div class="grid grid-cols-2 gap-4">
                      <div class="bg-blue-50 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-2">
                          <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-blue-600"></i>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500">Pick-up</p>
                            <p class="font-semibold text-gray-900">{{ booking.pick_up_location }}</p>
                          </div>
                        </div>
                        <p class="text-sm text-gray-600">
                          <i class="far fa-calendar text-gray-400 mr-2"></i>
                          {{ booking.pick_up_date|date:"M d, Y" }}
                        </p>
                      </div>
                      
                      <div class="bg-green-50 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-2">
                          <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-flag-checkered text-green-600"></i>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500">Drop-off</p>
                            <p class="font-semibold text-gray-900">{{ booking.drop_off_location }}</p>
                          </div>
                        </div>
                        <p class="text-sm text-gray-600">
                          <i class="far fa-calendar text-gray-400 mr-2"></i>
                          {{ booking.drop_off_date|date:"M d, Y" }}
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Status & Price -->
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold
                        {% if booking.status == 'confirmed' %}bg-green-100 text-green-700
                        {% elif booking.status == 'pending' %}bg-yellow-100 text-yellow-700
                        {% elif booking.status == 'completed' %}bg-blue-100 text-blue-700
                        {% elif booking.status == 'cancelled' %}bg-red-100 text-red-700
                        {% elif booking.status == 'in_progress' %}bg-purple-100 text-purple-700
                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                        {% if booking.status == 'confirmed' %}<i class="fas fa-check-circle"></i>
                        {% elif booking.status == 'pending' %}<i class="fas fa-clock"></i>
                        {% elif booking.status == 'completed' %}<i class="fas fa-flag-checkered"></i>
                        {% elif booking.status == 'cancelled' %}<i class="fas fa-times-circle"></i>
                        {% elif booking.status == 'in_progress' %}<i class="fas fa-car"></i>
                        {% endif %}
                        {{ booking.status|title }}
                      </span>
                    </div>
                    
                    <div class="text-right">
                      <div class="text-2xl font-bold text-gray-900">
                        ${{ booking.total_price|floatformat:2 }}
                      </div>
                      <p class="text-sm text-gray-500">{{ booking.duration_days }} days</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions Footer -->
            <div class="border-t border-gray-100 px-6 py-4 bg-gray-50">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-user-circle text-gray-400"></i>
                  <span>Driver: {{ booking.driver_option|default:"Self-drive" }}</span>
                </div>
                <div class="flex gap-3">
                  <a href="#" 
                     class="px-4 py-2 text-sm font-semibold text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-xl transition-colors">
                    <i class="fas fa-eye mr-2"></i>View Details
                  </a>
                  {% if booking.status == 'pending' or booking.status == 'confirmed' %}
                  <a href="#" 
                     class="px-4 py-2 text-sm font-semibold text-red-600 hover:text-red-800 hover:bg-red-50 rounded-xl transition-colors">
                    <i class="fas fa-times mr-2"></i>Cancel
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination (if needed) -->
      {% if bookings.has_other_pages %}
      <div class="mt-12 flex justify-center">
        <nav class="flex items-center gap-2">
          {% if bookings.has_previous %}
            <a href="?page={{ bookings.previous_page_number }}" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          {% for num in bookings.paginator.page_range %}
            {% if bookings.number == num %}
              <span class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold">{{ num }}</span>
            {% elif num > bookings.number|add:'-3' and num < bookings.number|add:'3' %}
              <a href="?page={{ num }}" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">{{ num }}</a>
            {% endif %}
          {% endfor %}
          
          {% if bookings.has_next %}
            <a href="?page={{ bookings.next_page_number }}" class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </nav>
      </div>
      {% endif %}

    {% else %}
      <!-- Empty State -->
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden text-center py-16 px-8">
        <div class="max-w-md mx-auto">
          <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-calendar-times text-blue-600 text-3xl"></i>
          </div>
          
          <h2 class="text-2xl font-bold text-gray-900 mb-3">
            No Bookings Yet
          </h2>
          
          <p class="text-gray-600 mb-8">
            You haven't made any bookings yet. Start your journey with Diako Rentals and experience premium car rentals.
          </p>

          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'cars' %}" 
               class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold px-8 py-3.5 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
              <i class="fas fa-car"></i>
              Browse Cars
            </a>
            
            <a href="{% url 'home' %}" 
               class="inline-flex items-center justify-center gap-2 bg-white border border-gray-300 hover:border-blue-500 text-gray-700 hover:text-blue-700 font-semibold px-8 py-3.5 rounded-xl transition-colors">
              <i class="fas fa-home"></i>
              Back to Home
            </a>
          </div>

          <!-- Recommended Cars -->
          <div class="mt-12 pt-12 border-t border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Popular Car Categories</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              {% for category in popular_categories %}
              <a href="{% url 'cars' %}?category={{ category.slug }}" 
                 class="bg-gray-50 hover:bg-blue-50 rounded-xl p-4 text-center transition-colors group">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-2 group-hover:bg-blue-200 transition-colors">
                  <i class="{{ category.icon }} text-blue-600"></i>
                </div>
                <span class="text-sm font-medium text-gray-700">{{ category.name }}</span>
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>

<!-- Filtering & Sorting JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const bookingCards = document.querySelectorAll('.booking-card');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    
    // Filter by status
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        
        // Update active button
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-blue-600', 'text-white');
          btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
        });
        
        this.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
        this.classList.add('active', 'bg-blue-600', 'text-white');
        
        // Filter cards
        bookingCards.forEach(card => {
          const status = card.getAttribute('data-status');
          
          if (filter === 'all' || status === filter) {
            card.style.display = 'block';
            setTimeout(() => {
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, 10);
          } else {
            card.style.opacity = '0';
            card.style.transform = 'translateY(10px)';
            setTimeout(() => {
              card.style.display = 'none';
            }, 300);
          }
        });
      });
    });
    
    // Search functionality
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      
      bookingCards.forEach(card => {
        const carName = card.querySelector('h4').textContent.toLowerCase();
        const bookingId = card.querySelector('h3').textContent.toLowerCase();
        const location = card.querySelector('.bg-blue-50 p').textContent.toLowerCase();
        
        if (carName.includes(searchTerm) || 
            bookingId.includes(searchTerm) || 
            location.includes(searchTerm)) {
          card.style.display = 'block';
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 10);
        } else {
          card.style.opacity = '0';
          card.style.transform = 'translateY(10px)';
          setTimeout(() => {
            card.style.display = 'none';
          }, 300);
        }
      });
    });
    
    // Sort functionality
    sortSelect.addEventListener('change', function() {
      const sortBy = this.value;
      const container = document.getElementById('bookingsContainer');
      const cards = Array.from(bookingCards);
      
      cards.sort((a, b) => {
        if (sortBy === 'newest') {
          return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
        } else if (sortBy === 'oldest') {
          return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
        } else if (sortBy === 'price_high') {
          return parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price'));
        } else if (sortBy === 'price_low') {
          return parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price'));
        }
        return 0;
      });
      
      // Re-append sorted cards with animation
      cards.forEach((card, index) => {
        setTimeout(() => {
          container.appendChild(card);
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          setTimeout(() => {
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 50);
        }, index * 50);
      });
    });
    
    // Add animation on scroll
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    }, observerOptions);
    
    bookingCards.forEach(card => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = 'opacity 0.6s, transform 0.6s';
      observer.observe(card);
    });
  });
</script>

<style>
  .booking-card {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s, transform 0.3s, box-shadow 0.3s;
  }
  
  .filter-btn.active {
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
  }
  
  .filter-btn:not(.active):hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}